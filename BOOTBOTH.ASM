10  *=$700
20 START=*
30  .BYTE 0
40  .BYTE 5
50  .WORD START
60  .WORD BPINIT
70 BPINIT LDA  #PND&255
80  STA MEMLO
90  STA APPMHI
0100  LDA #PND/256
0110  STA MEMLO+1
0120  STA APPMHI+1
0130  LDA #'E'
0140  STA $320
0150  LDA #ETAB&255
0160  STA $321
0170  LDA #ETAB/256
0180  STA $322
0190  LDA #'D'
0200  STA $329
0210  LDA #TAB&255
0220  STA $32A
0230  LDA #TAB/256
0240  STA $32B
0250  CLC
0260  RTS
0270 TAB .WORD OPEN-1
0280  .WORD CLOSE-1
0290  .WORD GETBYTE-1
0300  .WORD PUTBYTE-1
0310  .WORD STAT-1
0320  .WORD RET-1    ; XIO
0330  JMP RET        ; INIT
0340 STAT LDA #'S'   ; S FOR STATUS
0350  STA DAUX1
0360 STATMA LDA #$53 ;STAT MINUS AUX
0370  STA DCOMND
0380  JMP DSKIF      ; RETURN FROM THERE
0390 MEMLO=$2E7
0400 APPMHI=$E
0410 OPEN JSR DKSETUP
0420  LDA #'O'       ; O FOR OPEN
0430  STA DAUX2
0440  STX IOCBNUM
0450  LDA $344,X       ; POINTER TO FILE NAME 
0460  STA $304
0470  LDA $345,X
0480  STA $305
0490  JSR DBUFFL     ; SEND FILE NAME 
0500  LDA #0
0510  STA LASTX1     ; Is incemented as sectors fly
0520 DKSETUP LDA #DKBUF&255 ; SET BUFFER ADDRESS TO DKBUF
0530  STA $304
0540  LDA #DKBUF/256
0550  STA $305
0560  LDA #1
0570  STA $301
0580  LDA #'X'            ; NOT OPEN
0590  STA DAUX2
0600  INC LASTX1     ; new sector
0610  LDA LASTX1
0620  STA DAUX1
0630  RTS
0640 IOCBNUM .BYTE 0     ; IOCB NUMBER TIMES 16
0650 HOWUSED .BYTE 0
0660 CLOSE LDA HOWUSED
0670  CMP #'R'            ; R = READ
0680  BEQ DONECLOS        ; JMP NOT WRITE
0690 CLOSEL LDA #$1A
0700  JSR PUTBYTE
0710  LDX DKBPNT
0720  CPX #0
0730  BNE CLOSEL
0740 DONECLOS LDA #'C'  ; C FOR CLOSE
0750  STA DAUX2
0760  JMP DBUFFL      
0770 GETBYTE LDY #'R'
0780  STY HOWUSED
0790  LDX DKBPNT
0800  CPX #0
0810  BNE ISAB
0820  LDA #'R'
0830  STA DCOMND
0840  JSR DKSETUP
0850  JSR DSKIF
0860  CPY #SUCCES
0870  BNE RETURN
0880 ISAB LDX DKBPNT
0890  LDA DKBUF,X
0900  INX
0910  CPX #128
0920  BNE SETDBPNT
0930  LDX #0            ; IF IT WAS 128 MAKE IT 0
0940 SETDBPNT STX DKBPNT
0950  JSR WHATTYPE
0960  CPY #7          ; GET BINARY
0970  BEQ RET
0980  CMP #$1A
0990  BEQ EOF
1000  CMP #$0D
1010  BEQ GETBYTE
1020  CMP #$0A
1030  BNE RET
1040  LDA #$9B
1050 RET LDY #SUCCES
1060 RETURN RTS
1070 EOF LDY #$88
1080  RTS
1090 WHATTYPE LDY $A051
1100  LDX IOCBNUM
1110  CPY #$45
1120  BEQ ASMEDIT
1130  LDY $342,X
1140  RTS
1150 ASMEDIT CPX #$20
1160  BEQ OBJCODE
1170  LDY #$3
1180  RTS
1190 OBJCODE LDY #11
1200  RTS
1210 EOL LDA #$0D
1220  JSR PUTBYTE
1230  LDA #$0A            ; ON END OF LINE CPM NEEDS 2 CHARS
1240 PUTBYTE LDY #'W'      ; W= WRITE
1250  STY HOWUSED
1260  JSR WHATTYPE
1270  CPY #11         ; PUT BINARY
1280  BEQ PUTLIT
1290  CMP #$9B
1300  BEQ EOL
1310 PUTLIT LDX DKBPNT
1320  STA DKBUF,X
1330  INX
1340  CPX #128
1350  BNE NOTFUL        ; WE WILL WAIT FOR FULL 128
1360  JSR DKSETUP
1370 DBUFFL  LDA #'W'          ; W FOR WRITE 128
1380  STA DCOMND
1390  JSR DSKIF
1400  CPY #SUCCES
1410  BNE RETURN
1420  LDX #0            ; NOW BUFFER EMPTY
1430 NOTFUL STX DKBPNT
1440  LDY #SUCCES
1450  RTS
1460 DKBPNT .BYTE 0
1470 DKBUF .BYTE "                    " ; *=*+129
1480  .BYTE "12345678901234567890"
1490  .BYTE "42                  "
1500  .BYTE "                    "
1510  .BYTE "82                  "
1520  .BYTE "          129       "
1530  .BYTE "133                 "
1540 LASTX1 .BYTE 0
1550 PINIT LDA #ETAB&255
1560  STA $321
1570  LDA #ETAB/256
1580  STA $322
1590  .BYTE 0
1600 ETAB .WORD EOPEN-1
1610  .WORD RET-1    ; CLOSE
1620  .WORD EGETBYTE-1
1630  .WORD EPUTBYTE-1
1640  .WORD RET-1   ; STAT
1650  .WORD RET-1    ; XIO
1660  JMP RET        ; INIT
1670 EOPEN = $F3FC
1680 EGETBYTE JSR SWAP
1690  JSR ERANGE
1700  LDA BUFCNT
1710  BNE EGETC3
1720  LDA ROWCRS
1730  STA BUFSTR
1740  LDA COLCRS
1750  STA BUFSTR+1
1760 EGETC1 JSR KGETCH
1770  STY DSTAT
1780  LDA ATACHR
1790  CMP #$9B
1800  BEQ EGETC2
1810  JSR DOSS
1820  JSR SWAP
1830  LDA LOGCOL
1840  CMP #113
1850  BNE EGETC6
1860  JSR BELL
1870 EGETC6 JMP EGETC1
1880 EGETC3 JMP $F67C
1890 EGETC2 JMP $F66E
1900 KGETCH LDA #'K'
1910  STA DDEVIC
1920  LDA #1
1930  STA DUNIT
1940  STA DCOMND
1950  STA DAUX2
1960  STA DAUX1
1970  LDA #$40
1980  STA DSTATS    ; RECIEVE DATA FRAME P.131
1990  LDA #KEY&255
2000  STA $304
2010  LDA #KEY/256
2020  STA $305
2030  LDA #$FF
2040  STA DSKTIM
2050  STA DTIMLO
2060  LDA #0
2070  STA ATRACT
2080  STA $309
2090  LDA #1
2100  STA $308
2110  JSR SIOINV
2120  JSR SIOV
2130  LDA DSTATS
2140  CMP #SUCCES
2150  BNE KGETCH
2160  LDA KEY
2170  STA ATACHR
2180  RTS
2190 DTIMLO = $306
2200 SIOINV = $E465
2210 SIOV = $E459
2220 DDEVIC = $300
2230 DUNIT = $301
2240 DSTATS = $303
2250 DAUX2=$30B
2260 DAUX1=$30A
2270 DCOMND=$302
2280 DSKTIM=$246
2290 DSKIF=$E453
2300 EPUTBYTE=$F6A4
2310 SWAP=$FCB3
2320 ERANGE=$FA88
2330 BUFCNT=$006B
2340 ROWCRS = $0054
2350 BUFSTR=$006C
2360 COLCRS=$0055
2370 DSTAT=$004C
2380 ATACHR=$2FB
2390 DOSS=$F6AD
2400 LOGCOL=$0063
2410 BELL=$F90A
2420 ATRACT=$4D
2430 TIMFLG=$317
2440 TEMP = $23E
2450 SUCCES =1
2460 KEY .WORD 0
2470 PND .END
